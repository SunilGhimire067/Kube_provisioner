---
# Preflight checks for Kubernetes cluster nodes
- name: Preflight Checks
  hosts: k8s_cluster
  become: yes
  gather_facts: yes
  tasks:
    - name: Check minimum RAM (2GB)
      assert:
        that:
          - ansible_memtotal_mb >= 1800
        fail_msg: "Node requires at least 2GB RAM. Found: {{ ansible_memtotal_mb }}MB"
        success_msg: "RAM check passed: {{ ansible_memtotal_mb }}MB"

    - name: Check minimum CPU cores (2)
      assert:
        that:
          - ansible_processor_vcpus >= 2
        fail_msg: "Node requires at least 2 CPU cores. Found: {{ ansible_processor_vcpus }}"
        success_msg: "CPU check passed: {{ ansible_processor_vcpus }} cores"

    - name: Check OS family is RedHat (Rocky Linux)
      assert:
        that:
          - ansible_os_family == "RedHat"
        fail_msg: "OS must be RedHat family (Rocky/CentOS/RHEL). Found: {{ ansible_os_family }}"
        success_msg: "OS check passed: {{ ansible_distribution }} {{ ansible_distribution_version }}"

    - name: Check network connectivity to nodes
      wait_for:
        host: "{{ ansible_host }}"
        port: 22
        timeout: 10

    - name: Disable swap
      shell: swapoff -a
      changed_when: false

    - name: Remove swap from fstab
      lineinfile:
        path: /etc/fstab
        regexp: '.*swap.*'
        state: absent

    - name: Find active systemd swap units
      shell: systemctl list-units --type=swap --state=active --no-legend | awk '{print $1}'
      register: active_swap_units
      changed_when: false

    - name: Mask systemd swap units to prevent reactivation on reboot
      systemd:
        name: "{{ item }}"
        masked: yes
        state: stopped
      loop: "{{ active_swap_units.stdout_lines }}"
      when: active_swap_units.stdout_lines | length > 0

    - name: Check if swap logical volume exists (LVM)
      shell: lvs --noheadings -o lv_path --select 'lv_attr=~[^s].*' 2>/dev/null | grep -i swap || true
      register: swap_lv
      changed_when: false

    - name: Remove swap logical volume if present
      shell: "lvremove -f {{ item }}"
      loop: "{{ swap_lv.stdout_lines | map('trim') | select | list }}"
      when: swap_lv.stdout_lines | map('trim') | select | list | length > 0

    - name: Load required kernel modules
      modprobe:
        name: "{{ item }}"
        state: present
      loop:
        - overlay
        - br_netfilter

    - name: Ensure kernel modules load on boot
      copy:
        dest: /etc/modules-load.d/k8s.conf
        content: |
          overlay
          br_netfilter
        mode: '0644'

    - name: Set required sysctl params
      sysctl:
        name: "{{ item.name }}"
        value: "{{ item.value }}"
        state: present
        reload: yes
        sysctl_file: /etc/sysctl.d/k8s.conf
      loop:
        - { name: 'net.bridge.bridge-nf-call-iptables', value: '1' }
        - { name: 'net.bridge.bridge-nf-call-ip6tables', value: '1' }
        - { name: 'net.ipv4.ip_forward', value: '1' }

    - name: Check firewalld status
      systemd:
        name: firewalld
        state: stopped
        enabled: no
      ignore_errors: yes

    - name: Display preflight check summary
      debug:
        msg: |
          Preflight checks completed successfully!
          - Hostname: {{ ansible_hostname }}
          - OS: {{ ansible_distribution }} {{ ansible_distribution_version }}
          - RAM: {{ ansible_memtotal_mb }}MB
          - CPUs: {{ ansible_processor_vcpus }}
          - IP: {{ ansible_default_ipv4.address }}
